#!/bin/bash

if [ $EUID -ne 0 ]; then
    echo "ERROR: This tool must be run as root"
    exit 1
fi

#------------------------------------------------#
#                 Pre-requisites                 #
#------------------------------------------------#

apt-get update
apt-get install --yes debootstrap curl mbr extlinux parted kpartx wget ca-certificates
# An apt cache makes subsequent image-building much faster
apt-get install --yes apt-cacher-ng
apt-get upgrade

#------------------------------------------------#
#                 Image creation                 #
#------------------------------------------------#
if [ -f /tmp/raspberry-manager.img ]; then
    rm /tmp/raspberry-manager.img
fi

cylinders=2000
dd if=/dev/zero of=/tmp/raspberry-manager.img bs=516096c count=$cylinders

device=`losetup -f --show /tmp/raspberry-manager.img`

#Create partitions
fdisk -u -C$cylinders -S63 -H16 $device <<EOF
n
p
1


a
w
EOF

losetup -d $device

device=`kpartx -va /tmp/raspberry-manager.img | sed -E 's/.*(loop[0-9])p.*/\1/g' | head -1`
device="/dev/mapper/${device}"
bootp=${device}p1

kpartx -d /tmp/raspberry-manager.img
