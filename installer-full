#!/bin/bash

SUITE="jessie"
MIRROR="http://ftp.us.debian.org/debian/"

if [ $EUID -ne 0 ]; then
    echo "ERROR: This tool must be run as root"
    exit 1
fi

#------------------------------------------------#
#                 Pre-requisites                 #
#------------------------------------------------#

apt-get update
apt-get install --yes debootstrap curl mbr extlinux parted kpartx wget ca-certificates
# An apt cache makes subsequent image-building much faster
apt-get install --yes apt-cacher-ng
apt-get upgrade

#------------------------------------------------#
#                 Image creation                 #
#------------------------------------------------#
if [ -f /tmp/raspberry-manager.img ]; then
    rm /tmp/raspberry-manager.img
fi

cylinders=2000
dd if=/dev/zero of=/tmp/raspberry-manager.img bs=516096c count=$cylinders

#Create partitions
fdisk /tmp/raspberry-manager.img <<EOF
n
p
1


a
w
EOF

device=`kpartx -va /tmp/raspberry-manager.img | sed -E 's/.*(loop[0-9])p.*/\1/g' | head -1`
device="/dev/mapper/${device}"
rootp=${device}p1

# If we don't delay then errors happen
sleep 1

mkfs.ext2 $rootp
if [ $? -ne 0 ]; then
    echo "Error: failed to format image file partition."
    kpartx -d /tmp/raspberry-manager.img
    exit 1
fi

tune2fs -c 0 -i 0 $rootp

# Mount the partition
if [ ! -d /mnt/liveusb ]; then
    mkdir /mnt/liveusb
fi

mount $rootp /mnt/liveusb
if [ $? -ne 0 ]; then
    echo "Error: unable to mount image."
    kpartx -d /tmp/raspberry-manager.img
    exit 1
fi

# Setup the base Debian environment
debootstrap --arch=i386 --variant=minbase $SUITE /mnt/liveusb $MIRROR
if [ $? -ne 0 ]; then
    echo "Error: Unable to debootstrap"
    umount /mnt/liveusb
    kpartx -d /tmp/raspberry-manager.img
    exit 1
fi

kpartx -d /tmp/raspberry-manager.img
